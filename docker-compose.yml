version: "3.9"

services:
  # =============================
  # ðŸ§  DATABASE â€” PostgreSQL + pgvector
  # =============================
  db:
    image: ankane/pgvector:latest
    container_name: dagan-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: dagan
      POSTGRES_PASSWORD: daganaipassword
      POSTGRES_DB: dagancrag
    volumes:
      - ./data/db:/var/lib/postgresql/data
    networks:
      - dagan-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dagan -d dagancrag"]
      interval: 5s
      timeout: 5s
      retries: 5
  # =============================
  # ðŸ§  BACKEND â€” FastAPI
  # =============================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dagan-backend
    ports:
      - "8000:8080"
    env_file:
      - .env
    environment:
      TAVILY_API_KEY: ${TAVILY_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_CONNECTION_STRING: ${POSTGRES_CONNECTION_STRING}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      DOCUMENTS_COLLECTION: ${DOCUMENTS_COLLECTION:-crawled_documents}
      LLM_MODEL: ${LLM_MODEL:-gpt-4o-mini}
      LLM_TEMPERATURE: ${LLM_TEMPERATURE:-0.7}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-embedding-3-large}
      EMBEDDING_DIMENSIONS: ${EMBEDDING_DIMENSIONS:-2000}
    restart: unless-stopped
    networks:
      - dagan-network

  # =============================
  # ðŸ’» FRONTEND â€” React + Nginx
  # =============================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-https://dagan.novatekis.com/api}  
    container_name: dagan-frontend
    ports:
      - "80:80"
    env_file:
      - .env
    environment:
      VITE_API_URL: ${VITE_API_URL:-https://dagan.novatekis.com/api} 
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - dagan-network


# =============================
# ðŸ”— NETWORK
# =============================
networks:
  dagan-network:
    driver: bridge
